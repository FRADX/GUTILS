language: python

sudo: false

env:
  global:
    - secure: "veL3fKD4dYwyPqfuCL2wqy20HVEtp+Ii6FEawKGUZ3hQq9FxyNGRpo1CbbkQlkZYZH9OXUzCQRM7r8GZod69V1vWCZYIVvvIMolyWhbDb6755t3SMhc7/oFD2W+r/bEWiIvaLj9vUKEX9vxqE0O7NHqR9nnYn7k0ufAx7cts3OONn17wjWFOgYYAsECxUw31shvJ8j7Pvfv9+1yQo1S8lzkmWmeroWx7uIUXyOZK/BxixfwOadgWD+QPkP8jiIcWLvorFfH05Mx1T9hWTBYLW9QhSQnbi3SXtu+Fa4aMbABAvEhEfhUM12NHOpttYHsZ8wYkWQEDf1QWHc8ckLSKn9oYT6+LRkmS5xgMuTL7Yb8MpD9PI2AUhjE3/oLZUE0ITXp1w8iROz/LLVXDMJL5Zq1oufqeanXZW7K2OlDgfP7WdOb678Msq+wss+JmJc9wXF1NrYJEn66T3JNYtUVHmgk2fdnd1lw/+XXe6wCpkH8Qju4cR0gt/GaFH03ZzatefdxjoCrPU5XINJtD1eQv9pShEmr2dn1ocfi2lWcYHyCtYzUJlHSQ7yNgsN7QfL/We9dgZ88yB5O4HqcciaTAX5MYZWz2BFm4bZitKc0wFNkpEORQjkDC27MzxPKiaQ0lIzrvG5Dsaz3bninLIooP6wbIaL6nbFv4U/+duPvpb0w="

matrix:
  fast_finish: true
  include:
    - python: 2.7
      env: TEST_TARGET=default
    - python: 3.5
      env: TEST_TARGET=default
    - python: 3.6
      env: TEST_TARGET=default
    - python: 3.6
      env: TEST_TARGET=coding_standards
    - python: 3.6
      env: TEST_TARGET=docs
  allow_failures:
    - python: 3.6
      env: TEST_TARGET=coding_standards
    - python: 3.6
      env: TEST_TARGET=docs

before_install:
  # Install miniconda
  # -----------------
  - export CONDA_BASE=http://repo.continuum.io/miniconda/Miniconda
  - wget ${CONDA_BASE}3-3.7.0-Linux-x86_64.sh -O miniconda.sh;
  - bash miniconda.sh -b -p $HOME/miniconda
  - export PATH="$HOME/miniconda/bin:$PATH"

  # Setup conda
  # ------------------------------------
  - conda config --set always_yes yes --set changeps1 no
  - conda config --set show_channel_urls True
  - conda config --add create_default_packages pip
  - conda update --quiet conda

  # Add 3rd party channels
  # ------------------------------------
  - conda config --add channels conda-forge
  - conda config --add channels axiom-data-science

  # Create our environment
  # ------------------------------------
  - ENV_NAME='test-environment'
  - conda create --quiet -n $ENV_NAME python=$TRAVIS_PYTHON_VERSION
  - source activate $ENV_NAME

  # Install testing requirements
  # ------------------------------------
  - conda install --file requirements.txt --file gutils/tests/requirements.txt
  - conda list --export

install:
  - python setup.py sdist && version=$(python setup.py --version) && pushd dist && pip install gutils-${version}.tar.gz && popd

script:
  - set -e

  - if [[ $TEST_TARGET == "default" ]]; then
      py.test --disable-warnings ;
    fi

  - if [[ $TEST_TARGET == "coding_standards" ]]; then
      py.test --disable-warnings --pep8 -m pep8 ;
      py.test --disable-warnings --flakes -m flakes ;
    fi

  - if [[ $TEST_TARGET == 'docs' ]]; then
      ./docs/deploy.sh ;
    fi

after_success:
  - if [ "$TRAVIS_PULL_REQUEST" == "false" ] && [ "$TRAVIS_TAG" != "" ] && [ "$TEST_TARGET" == "default" ]; then
      conda install -n root conda-build anaconda-client ;
      conda build conda-recipe --python $TRAVIS_PYTHON_VERSION ;
      anaconda -t $ANACONDA_TOKEN upload --force -u axiom-data-science $HOME/miniconda/**/gutils-*.tar.bz2 ;
    fi

deploy:
  provider: releases
  api_key:
    secure: 76K3ayTtDeEyEhtOftO3EnAOpg0uQ3vM+0rS7lr9O7otAbP3Kb4U37fPezqVMfFsjgy+J3EXqtpkIMMBj++Y+wRJV9NH1KXuNaro9OWjzXomvP3+O24qhDTwO5IWrqrApvTMaDUEcjysZ72PbY8KUysOp5xtsDAeNidJg7C5XOEITVeT2yqHKVmaVK+ndDEGtM71hzHCP5swx44fiqQ9LwWM2OI+OuozJHiBBE6uMgp/4OLX5vv61K71eADfsm9RyQe2+PqrBFfXUCWVSwPyuKBWM6YkjuSl6UpMJH5y+Q9iPP6sFZi31RfDbMG3s5rr5Qbi1+lIiKsVDfFWcU+O/jJqtfbgeNu/QsGL70Xu9iJhnioKE6QEDWbfwgeIsXhpXcd8VvTiW7HAWn244naFMcDvWhbXc28kv/NRWgh8rYI+gXg4m9ugK6XgrVc6ywY4/zRvWNpaarFciDiaYH0/rW3bmmiIVdS84FGiwYl/rjlkQtorvbo5PMUTa5VQDmZGICYHbFV5FEf1fyIHJCi+6k4yobGCg8KxaVJW3g6hONqdKX8rGmWlxCYHE+3eShNxGb/QndqP2XeorTeg2BCWTpqrvPeYWfqqfu9CSTzlDdaPNjxPp2qDiZpQ5y2gcBiT3wRXdY1ju+E3EBOYk8lE/XgdG7fAtJ5Yfs8lgwa8nZA=
  on:
    tags: true
